;; Automatically converted from old syntax;
;; comments were lost during conversion.

(ns
 kalman-filter
 (:require
  [clojure.core.matrix
   :refer
   [identity-matrix mmul]
   :rename
   {identity-matrix eye}]
  mikera.vectorz.core)
 (:use [embang runtime emit]))

(declare H)

(declare data)

(declare predict-angles x)

(with-primitive-procedures
  [eye mmul]
  (defquery
    kalman-filter
    (let
      [T 50]
      (let
        [D 16]
        (let
          [omega (* (sample (gamma 5.0 2.5)) (/ Math/PI T))]
          (let
            [A
             (vector
               (vector (cos omega) (- (sin omega)))
               (vector (sin omega) (cos omega)))]
            (let
              [w (sample (gamma 10.0 100.0))]
              (let
                [W (mmul (eye 2) w)]
                (let
                  [q 0.01]
                  (let
                    [Q (mmul (eye D) q)]
                    (let
                      [x
                       (mem
                         (fn
                           x
                           [t]
                           (if
                             (< t 1)
                             (vector 1.0 0.0)
                             (sample (mvn (mmul A (x (dec t))) W)))))]
                      (reduce
                        (fn
                          [_ record]
                          (observe
                            (mvn (mmul H (x (first record))) Q)
                            (second record)))
                        ()
                        data)
                      (predict 'w w)
                      (predict 'omega omega))))))))))))

(def H
 [[0.17435 0.0025215]
  [1.5101E-8 0.14628]
  [0.0011861 0.059692]
  [0.35349 1.122E-7]
  [0.018924 2.2386E-4]
  [0.018625 0.014326]
  [5.8814E-22 7.9644E-4]
  [1.9282E-6 0.03197]
  [0.041361 0.0031349]
  [0.35481 3.509E-4]
  [0.0040861 0.085815]
  [1.704E-4 3.077E-5]
  [9.1995E-5 0.0015596]
  [0.032624 4.4134E-10]
  [6.6385E-17 0.047347]
  [2.8195E-4 0.60595]])

(def data
 [[1
   [0.0030852
    0.069439
    0.05778
    0.34676
    0.11497
    -0.039397
    -0.062434
    -0.10043
    -0.040935
    0.301
    -0.013963
    -0.11565
    0.081338
    0.068996
    0.088767
    0.025206]]
  [2
   [0.073722
    0.10727
    0.025952
    0.39253
    -0.0020681
    0.21119
    0.0030483
    0.08303
    0.0327
    0.10143
    0.069931
    0.015356
    -0.15635
    -0.040049
    0.0019222
    -0.026356]]
  [3
   [0.16686
    0.12143
    -0.04904
    0.27357
    -0.04666
    0.054066
    0.093124
    -0.15183
    -0.088246
    0.075608
    0.037071
    -0.01928
    0.067195
    -0.15425
    -0.21773
    -0.019935]]
  [4
   [0.046086
    0.0477
    0.036401
    0.086298
    -0.033745
    0.012076
    -0.12208
    -0.16662
    0.18199
    0.24655
    0.083638
    0.055599
    0.13137
    -0.030493
    -0.010193
    0.30522]]
  [5
   [0.07031
    0.064494
    0.071797
    -0.0041467
    -0.025155
    0.012846
    0.068739
    0.091927
    -0.068837
    0.10728
    0.046146
    -0.16773
    0.044092
    -0.15314
    0.0052755
    0.64245]]
  [6
   [0.025436
    0.1075
    -0.13541
    0.33867
    -0.070459
    0.16263
    -0.010407
    0.14878
    0.21005
    0.20722
    0.2939
    -0.067851
    0.074042
    -0.074709
    -0.082813
    0.44669]]
  [7
   [0.041012
    0.030485
    -0.021571
    -0.045355
    -0.092957
    0.18353
    0.12145
    0.14586
    -0.096536
    -0.071386
    0.010943
    -0.028929
    -0.072512
    -0.073597
    0.1118
    0.38402]]
  [8
   [-0.076979
    -0.014035
    0.18177
    0.07169
    0.11543
    -0.041921
    0.031629
    -0.029916
    -0.1087
    -0.03556
    -0.18922
    -0.015249
    -0.073823
    -0.0089728
    0.18693
    0.58833]]
  [9
   [-0.03387
    0.32908
    -0.0089162
    0.012673
    0.12409
    -0.0098379
    -0.043556
    0.087502
    -0.097749
    -0.22984
    0.17115
    0.1023
    0.11271
    0.0046955
    0.025215
    0.79253]]
  [10
   [-0.20393
    0.24523
    -0.016856
    -0.44569
    -0.11698
    0.022954
    6.4876E-4
    0.028723
    -0.15841
    -0.20721
    0.15128
    -0.06432
    0.10505
    -0.12709
    0.075798
    0.39697]]
  [11
   [0.061252
    -0.032806
    0.010764
    -0.24819
    0.033577
    -0.1223
    -0.025479
    -0.041803
    -0.14328
    -0.11504
    -0.064965
    0.08036
    -0.014917
    0.18617
    -0.064478
    0.2122]]
  [12
   [-0.14325
    0.13327
    0.075271
    -0.2275
    -0.26703
    0.013538
    0.0081332
    -0.010428
    -0.15238
    -0.30145
    0.030586
    -0.04944
    -0.010655
    -0.054672
    0.033044
    0.27575]]
  [13
   [-0.32881
    0.13744
    -0.07766
    -0.099467
    -0.051046
    0.029771
    -0.12289
    0.062204
    -0.0096209
    -0.16084
    0.14706
    0.13497
    -0.038453
    0.073879
    0.18227
    -0.044537]]
  [14
   [-0.053775
    0.01889
    0.1317
    -0.41254
    -0.10146
    -0.057702
    0.10472
    0.092392
    -0.033188
    -0.1462
    0.026688
    -0.043569
    0.035827
    -0.055998
    0.21287
    0.14077]]
  [15
   [0.11281
    0.0090425
    -0.084429
    -0.16365
    0.11982
    -0.14906
    -0.014289
    -0.066673
    -0.012131
    -0.34665
    -0.10642
    0.26131
    -0.068739
    -0.093291
    0.070988
    -0.021726]]
  [16
   [0.0022429
    -0.021331
    -0.066929
    0.018204
    0.0024813
    0.1173
    0.064028
    -0.040898
    -0.019798
    -0.24697
    0.016388
    -0.11586
    0.11106
    0.051147
    0.14527
    0.34336]]
  [17
   [-0.16724
    0.1342
    0.04978
    -0.18703
    0.09079
    -0.12283
    -0.026274
    0.13317
    -0.18407
    -0.30198
    0.12865
    -0.015769
    -0.24484
    -0.12172
    0.1637
    0.095147]]
  [18
   [-0.13853
    -0.013268
    -0.1412
    0.033701
    0.046589
    -0.031064
    -0.091824
    -0.10281
    0.19923
    -0.17697
    0.16571
    -0.15825
    -0.077739
    0.038347
    0.0028676
    0.29357]]
  [19
   [-0.13672
    0.019378
    -0.067887
    -0.069882
    -0.025986
    0.034188
    0.094191
    0.054705
    0.011956
    -0.20521
    0.1429
    0.056514
    0.045663
    7.023E-4
    -0.063477
    -0.030724]]
  [20
   [-0.02218
    -0.071622
    -0.093586
    0.061501
    -0.1285
    0.057039
    -0.1585
    -0.064525
    -0.032886
    0.090853
    0.022086
    0.023494
    0.02766
    0.13705
    0.14179
    0.25121]]
  [21
   [0.013094
    0.010287
    -0.049793
    0.010058
    -0.030392
    -0.22695
    0.0065242
    0.043709
    0.18243
    0.17398
    -0.039111
    0.076209
    0.012635
    0.059673
    -0.11405
    -0.25019]]
  [22
   [-0.17717
    0.043338
    -0.093853
    0.013672
    0.042703
    -0.059138
    -0.036152
    0.054837
    -0.10164
    0.17495
    -0.17992
    -0.091148
    0.065767
    -0.15466
    0.043451
    -0.047979]]
  [23
   [-0.051112
    0.043034
    0.056914
    0.017617
    0.0060642
    -0.032326
    -0.072693
    0.01796
    -0.056602
    5.6809E-4
    -0.092343
    -0.0082839
    -0.19398
    0.13719
    0.15113
    0.051223]]
  [24
   [-0.02477
    -0.14971
    -0.081196
    -0.060515
    0.0092617
    -0.047847
    -0.063824
    0.082798
    -0.069468
    0.02494
    0.096224
    -0.0056966
    0.23045
    0.050626
    0.16109
    0.28182]]
  [25
   [-0.25595
    0.081226
    0.035181
    -0.29832
    -0.05884
    0.0052923
    0.17093
    -0.093093
    -0.080789
    -0.23775
    0.13102
    0.050294
    -0.13863
    0.0053026
    0.066305
    0.13039]]
  [26
   [-0.19515
    -0.2801
    0.069038
    -0.13002
    0.12216
    -0.17475
    0.10903
    0.20933
    -0.040472
    -0.23773
    0.074684
    -0.065401
    -0.065108
    0.039737
    0.04058
    0.080193]]
  [27
   [-0.095533
    -0.0053419
    -0.11223
    -0.098702
    -0.041526
    -0.049459
    0.012894
    0.016458
    0.038896
    -0.035941
    0.027615
    -0.094086
    0.10026
    -0.057029
    -0.087127
    0.20374]]
  [28
   [-0.16404
    0.2649
    -0.068077
    -0.10155
    0.054225
    0.14427
    0.19424
    0.061935
    0.033472
    0.012783
    -0.10026
    0.0092933
    -0.053585
    -0.15785
    0.030067
    0.099104]]
  [29
   [-0.076509
    0.082532
    -0.14114
    -0.23114
    0.012382
    -0.067685
    -0.02399
    0.028486
    -0.0128
    -0.11619
    -0.01683
    -0.053585
    -0.030477
    -0.036533
    -0.10114
    0.16262]]
  [30
   [-0.095042
    -0.07099
    0.049696
    -0.067652
    0.03691
    0.013618
    -0.026283
    -0.039967
    0.069895
    -0.10675
    -0.045653
    0.089653
    -0.096902
    0.179
    0.023169
    0.072133]]
  [31
   [-0.21516
    -0.035187
    -0.014916
    -0.11485
    -0.11452
    -0.097489
    0.075638
    -0.034546
    -0.081632
    -0.33215
    0.071153
    0.0066982
    -0.092395
    0.060414
    0.023131
    0.35924]]
  [32
   [-0.17179
    0.14204
    0.022946
    -0.079981
    -0.0086598
    0.1249
    -0.043039
    0.15076
    0.074673
    -0.097452
    0.060665
    0.054374
    -0.093687
    -0.13334
    0.11098
    0.14878]]
  [33
   [-0.22668
    0.11119
    -0.14844
    -0.21194
    0.078308
    -0.15788
    -0.039786
    0.14867
    -0.12024
    -0.082758
    0.14087
    -0.14921
    -0.0025041
    0.11294
    0.0077593
    0.064565]]
  [34
   [-0.164
    -0.029986
    0.058737
    -0.55482
    0.027098
    -0.15681
    0.20314
    -0.0442
    -0.084894
    -0.74621
    0.010373
    0.041664
    0.20526
    -0.091737
    -0.16004
    0.12798]]
  [35
   [-0.34455
    -0.036315
    -0.083051
    -0.64273
    0.088851
    -0.075578
    0.086139
    -0.032643
    -0.056309
    -0.71901
    0.070437
    -0.028736
    0.032358
    -0.14561
    -0.12689
    0.034479]]
  [36
   [-0.25002
    0.043314
    -0.091532
    -0.51009
    0.041301
    0.018752
    0.017914
    0.0061599
    -0.087421
    -0.5099
    0.079685
    -0.08223
    -0.026869
    0.0050463
    -0.006872
    -0.28315]]
  [37
   [-0.32607
    -0.068207
    -0.14212
    -0.11021
    -0.10228
    0.017597
    -0.0087973
    -0.17528
    0.11741
    -0.31822
    -0.0073905
    -0.045673
    -0.088242
    0.083684
    -0.045975
    -0.70608]]
  [38
   [0.015682
    -0.25743
    -0.12411
    -0.38174
    0.031187
    -0.12095
    -0.051573
    -0.0010591
    0.12914
    -0.19885
    -0.31433
    -0.018009
    -0.085469
    0.10506
    -0.11824
    -0.97766]]
  [39
   [-0.015535
    -0.25552
    0.10704
    -0.24022
    -0.027013
    -0.06552
    -0.039168
    -0.17503
    0.027888
    -0.18541
    -0.083275
    -0.010386
    8.3554E-4
    0.24546
    -0.14552
    -0.90785]]
  [40
   [0.096466
    -0.1005
    -0.037904
    -0.38679
    0.032902
    0.13389
    -0.098768
    0.014353
    0.050942
    -0.1882
    -0.22362
    0.047137
    0.16867
    -0.14583
    -0.079217
    -1.1279]]
  [41
   [-0.14857
    -0.30538
    -0.068272
    -0.14616
    -0.046398
    -0.13817
    0.017694
    -0.2204
    -0.085187
    -0.24004
    -0.26168
    -0.041455
    0.1151
    -0.058385
    0.080896
    -0.94823]]
  [42
   [-0.13397
    -0.20574
    -0.09402
    -0.29887
    -0.0067954
    -0.22667
    0.057647
    -0.054982
    0.012776
    -0.40394
    -0.096187
    0.013733
    -0.053326
    -0.04916
    -0.053341
    -1.1531]]
  [43
   [-0.12896
    -0.27993
    -0.089286
    -0.045247
    -0.035834
    -0.18914
    -0.12963
    0.091803
    0.052219
    -0.096104
    -0.06213
    0.026113
    0.013211
    -0.063008
    -0.051405
    -0.99649]]
  [44
   [0.12152
    -0.31344
    -0.14374
    0.2095
    0.15594
    -0.0033602
    0.025348
    -0.047665
    -0.2466
    -0.0050181
    -0.016765
    0.0555
    -0.1312
    0.052414
    -0.24279
    -1.0112]]
  [45
   [0.051754
    -0.23741
    -0.0024943
    0.26501
    -0.10179
    0.13578
    0.025618
    -0.12624
    -0.033134
    0.16006
    -0.003097
    -0.090994
    0.051062
    0.019603
    -0.17335
    -0.71639]]
  [46
   [0.078931
    -0.24737
    0.06933
    0.044789
    -0.045341
    0.085456
    0.21881
    -0.0088983
    0.045026
    0.24118
    -0.18791
    -0.072386
    0.16681
    -0.013332
    0.080621
    -0.93342]]
  [47
   [-0.041482
    -0.39403
    -0.14498
    0.28361
    -0.081689
    -0.064441
    -0.052852
    0.10101
    -0.067175
    0.19923
    -0.29223
    0.038866
    0.15632
    0.10317
    -0.056487
    -1.0869]]
  [48
   [0.24965
    -0.15419
    -0.03392
    0.18036
    -0.045629
    -0.086515
    0.10623
    -0.11537
    0.21038
    0.36348
    -0.10922
    0.010703
    0.022265
    -0.1175
    -0.14582
    -1.066]]
  [49
   [0.02018
    -0.40645
    -0.20926
    0.22857
    0.090316
    -0.0066879
    0.060363
    -0.10821
    -0.0027369
    0.30745
    -0.054711
    0.025546
    0.0059082
    0.031657
    -0.14576
    -1.0088]]
  [50
   [0.19765
    -0.095476
    -0.08812
    0.30295
    -0.14055
    -0.13474
    -0.053639
    -0.15403
    -0.025956
    0.16712
    -0.16509
    0.033005
    -0.084615
    -0.031582
    -0.11673
    -0.68144]]])

(defm angle [x] (atan (/ (second x) (first x))))

(defm
 predict-angles
 [x]
 (predict '(angle (x 1)) (angle (x 1)))
 (predict '(angle (x 2)) (angle (x 2)))
 (predict '(angle (x 3)) (angle (x 3)))
 (predict '(angle (x 4)) (angle (x 4)))
 (predict '(angle (x 5)) (angle (x 5)))
 (predict '(angle (x 6)) (angle (x 6)))
 (predict '(angle (x 7)) (angle (x 7)))
 (predict '(angle (x 8)) (angle (x 8)))
 (predict '(angle (x 9)) (angle (x 9)))
 (predict '(angle (x 10)) (angle (x 10)))
 (predict '(angle (x 11)) (angle (x 11)))
 (predict '(angle (x 12)) (angle (x 12)))
 (predict '(angle (x 13)) (angle (x 13)))
 (predict '(angle (x 14)) (angle (x 14)))
 (predict '(angle (x 15)) (angle (x 15)))
 (predict '(angle (x 16)) (angle (x 16)))
 (predict '(angle (x 17)) (angle (x 17)))
 (predict '(angle (x 18)) (angle (x 18)))
 (predict '(angle (x 19)) (angle (x 19)))
 (predict '(angle (x 20)) (angle (x 20)))
 (predict '(angle (x 21)) (angle (x 21)))
 (predict '(angle (x 22)) (angle (x 22)))
 (predict '(angle (x 23)) (angle (x 23)))
 (predict '(angle (x 24)) (angle (x 24)))
 (predict '(angle (x 25)) (angle (x 25)))
 (predict '(angle (x 26)) (angle (x 26)))
 (predict '(angle (x 27)) (angle (x 27)))
 (predict '(angle (x 28)) (angle (x 28)))
 (predict '(angle (x 29)) (angle (x 29)))
 (predict '(angle (x 30)) (angle (x 30)))
 (predict '(angle (x 31)) (angle (x 31)))
 (predict '(angle (x 32)) (angle (x 32)))
 (predict '(angle (x 33)) (angle (x 33)))
 (predict '(angle (x 34)) (angle (x 34)))
 (predict '(angle (x 35)) (angle (x 35)))
 (predict '(angle (x 36)) (angle (x 36)))
 (predict '(angle (x 37)) (angle (x 37)))
 (predict '(angle (x 38)) (angle (x 38)))
 (predict '(angle (x 39)) (angle (x 39)))
 (predict '(angle (x 40)) (angle (x 40)))
 (predict '(angle (x 41)) (angle (x 41)))
 (predict '(angle (x 42)) (angle (x 42)))
 (predict '(angle (x 43)) (angle (x 43)))
 (predict '(angle (x 44)) (angle (x 44)))
 (predict '(angle (x 45)) (angle (x 45)))
 (predict '(angle (x 46)) (angle (x 46)))
 (predict '(angle (x 47)) (angle (x 47)))
 (predict '(angle (x 48)) (angle (x 48)))
 (predict '(angle (x 49)) (angle (x 49)))
 (predict '(angle (x 50)) (angle (x 50))))
